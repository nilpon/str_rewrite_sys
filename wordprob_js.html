<!DOCTYPE html>
<html>
	<head>
		<title>Word Problem</title>
		<meta charset="utf-8"/>
		<script src="wordprob.js"></script>
		<script src="tab.js"></script>
		<link rel="stylesheet" href=wordprob.css>
	</head>
	<body>
	<h1>Monoid書換え系シミュレータ</h1>
	Monoid:
	<select id="list_monoid" onChange="change_monoid()">
		<option value="0">monoid0</option>
	</select>
	<input type="button" onclick="btn_change_monoidname()" value="名前変更">
	<input type="button" onclick="btn_new_monoid()" value="新規">
	<input type="button" onclick="btn_remove_monoid()" value="削除">
	
	<hr>

	<div id="working_area"></div>

	<script language="javascript" type="text/javascript">
	let monlist = [], monnamelist = [];
	monlist.push(new Monoid);
	monnamelist.push("monoid0");
	let mon = monlist[0];
	let tab_working_area = Tab.new("working_area");
	let page_relation = construct_relation_page();
	let page_calc = construct_calc_page();
	let page_save = construct_save_page();

	Tab.onclick(tab_working_area, page_relation);


	function set_text(elem, txt) {
		elem.appendChild(document.createTextNode(txt));
	}

	function set_textbox(elem, id, value, onfocus = null, readonly = false) {
		let txtbox = document.createElement("input");
		txtbox.setAttribute("type", "text");
		txtbox.setAttribute("id", id);
		txtbox.setAttribute("value", value);
		if(onfocus) {
			txtbox.setAttribute("onfocus", onfocus);
		}
		if(readonly) {
			txtbox.readOnly = true;
		}

		elem.appendChild(txtbox);
	}

	function set_button(elem, txt, onclick) {
		let btn = document.createElement("input");
		btn.setAttribute("type", "button");
		btn.setAttribute("value", txt);
		btn.setAttribute("onclick", onclick);

		elem.appendChild(btn);
	}

	function set_div(elem, id) {
		let div = document.createElement("div");
		div.setAttribute("id", id);
		elem.appendChild(div);
	}

	function set_br(elem) {
		elem.appendChild(document.createElement("br"));
	}

	function construct_relation_page() {
		let cntarea = document.createElement("div");

		set_text(cntarea, "新しい関係式:");
		set_textbox(cntarea, "relation_left", "");
		set_text(cntarea, " = ");
		set_textbox(cntarea, "relation_right", "");
		set_button(cntarea, "追加", "btn_add_relation()");
		set_br(cntarea);

		set_button(cntarea, "整列", "btn_sort()");
		set_button(cntarea, "Knuth-Bendix", "btn_KB()");
		set_button(cntarea, "全選択", "btn_selall()");
		set_button(cntarea, "消去", "btn_erase()");
		set_button(cntarea, "合流的か？", "btn_confluence()");
		set_button(cntarea, "派生Monoid生成", "btn_gen_submon()");

		set_div(cntarea, "relation_view");
		return Tab.newpage(tab_working_area, "関係式一覧", cntarea.innerHTML, page_update);
	}

	function construct_save_page() {
		let cntarea = document.createElement("div");

		set_text(cntarea, "セーブデータ:");
		set_textbox(cntarea, "save_txtbox", "", "this.select()");
		set_button(cntarea, "インポート", "btn_import()");

		return Tab.newpage(tab_working_area, "セーブ", cntarea.innerHTML, btn_export);
	}

	function construct_calc_page() {
		let cntarea = document.createElement("div");

		return Tab.newpage(tab_working_area, "計算", cntarea.innerHTML);
	}

	function btn_add_relation() {
		let rel_left = sanitize(document.getElementById("relation_left").value);
		let rel_right = sanitize(document.getElementById("relation_right").value);
		mon.add_relation(rel_left, rel_right);
		page_update();
	}

	function page_update() {
		show_monoid_list();
		set_mon();
		show_relations();
	}

	function show_relations() {
		let rel_view = document.getElementById("relation_view");

		if(rel_view) {
			rel_view.innerHTML = "";
			let rel_view_form = document.createElement("form");
			rel_view_form.setAttribute("name", "rel_checkboxes");

			let counter = 1;
			for(const rel of mon.relations) {
				let chkbox = document.createElement("input");
				chkbox.setAttribute("type", "checkbox");
				chkbox.setAttribute("name", "rels");
				rel_view_form.appendChild(chkbox);
				
				let relation_txt = "" + counter + ". ";
				if(rel.second.length) {
					relation_txt += rel.first + " = " + rel.second;
				}
				else {
					relation_txt += rel.first + " = ε";
				}
				rel_view_form.appendChild(document.createTextNode(relation_txt));
				rel_view_form.appendChild(document.createElement("br"));

				counter++;
			}
			if(!mon.relations.length) {
				rel_view_form.appendChild(document.createTextNode("なし"));
			}

			rel_view.appendChild(rel_view_form);
		}
	};

	function show_monoid_list() {
		let list_monoid = document.getElementById("list_monoid");
		let selected = list_monoid.selectedIndex;

		while(list_monoid.lastChild) list_monoid.removeChild(list_monoid.lastChild);
		for(let i = 0; i < monlist.length; i++) {
			let option = document.createElement("option");
			option.setAttribute("value", i);
			option.innerHTML = monnamelist[i];
			list_monoid.appendChild(option);
		}

		if(selected >= monlist.length) selected = monlist.length - 1;
		list_monoid.options[selected].selected = true;
	}

	function btn_sort() {
		mon.sort_relations();
		page_update();
	}

	function btn_KB() {
		mon.Knuth_Bendix(10000);
		page_update();
	}

	function btn_selall() {
		let myrels = document.rel_checkboxes.rels;
		
		if(myrels) {
			if(myrels.length > 1) {
				for(const box of myrels) {
					box.checked = true;
				}
			}
			else {
				myrels.checked = true;
			}
		}
	}

	function btn_erase() {
		let myrels = document.rel_checkboxes.rels;
		let counter = 0;
		
		if(myrels) {
			if(myrels.length > 1) {
				for(const box of myrels) {
					if(box.checked) mon.relations[counter].first = "";
					counter++;
				}
			}
			else {
				if(myrels.checked) mon.relations[0].first = "";
			}
			mon.relations = mon.relations.filter( function (rel) {
  	    return rel.first;
    	});
			page_update();
		}
	}

	function btn_confluence() {
		is_confl = mon.confluence();
		if(is_confl) alert("合流的ですO(^o^)O");
		else alert("合流的じゃない;O(>o<)O;");
	}

	function set_mon() {
		let listbox = document.getElementById("list_monoid");
		mon = monlist[listbox.options[listbox.selectedIndex].value];
	}

	function change_monoid() {
		page_update();
	}

	function btn_change_monoidname() {
		let listbox = document.getElementById("list_monoid");
		
		let newname = sanitize(window.prompt(monnamelist[listbox.selectedIndex] + "の新しい名前", monnamelist[listbox.selectedIndex]));
		if(newname) {
			monnamelist[listbox.selectedIndex] = newname;
			page_update();
		}
	}

	function monoid_list_select(index) {
		let list_monoid = document.getElementById("list_monoid");
		if(index >= monlist.length) index = monlist.length - 1;
		list_monoid.options[index].selected = true;
		page_update();
	}

	function btn_new_monoid(name_cand = "") {
		if(!name_cand) name_cand = "monoid" + monlist.length;

		let newname = sanitize(window.prompt("新しいMonoidの名前", name_cand));
		if(newname) {
			monnamelist.push(newname);
			monlist.push(new Monoid);
			page_update();
			monoid_list_select(monlist.length - 1);
		}

		return newname;
	}

	function btn_remove_monoid() {
		let listbox = document.getElementById("list_monoid");

		if(monlist.length <= 1) {
			alert("最後の一つは削除できません！");
			return;
		}

		if(confirm("本当に" + monnamelist[listbox.selectedIndex] + "を削除しますか(´・ω・`)？")) {
			monnamelist.splice(listbox.selectedIndex, 1);
			monlist.splice(listbox.selectedIndex, 1);
			page_update();
		}
	}

	function btn_gen_submon() {
		let list_monoid = document.getElementById("list_monoid");
		let name_cand = monnamelist[list_monoid.selectedIndex] + "_sub";
		let newrellist = [];
		let myrels = document.rel_checkboxes.rels;
		
		if(myrels) {
			let counter = 0;
			if(myrels.length > 1) {
				for(const box of myrels) {
					if(box.checked) {
						name_cand += counter + 1;
						let reltoadd = mon.relations[counter];
						newrellist.push(new Relation(reltoadd.first, reltoadd.second));
					}
					counter++;
				}
			}
			else {
				if(myrels.checked) newrellist.push(mon.relations[0]);
			}

			if(btn_new_monoid(name_cand)) {
				mon.relations = newrellist.slice();
			}
			page_update();
		}
	}

	function sanitize(text) {
		if(text) return text.replace(/[\x00-\x20<=>"'&\x7f-\x9f]/g, "");
		else return "";
	}

	// format: monname0<rel0f=rel0s&rel1f=rel1s&...>monname1...
	function btn_export() {
		monlist_data = "";
		for(let i = 0; i < monlist.length; i++) {
			monlist_data += monnamelist[i] + "<";
			for(const rel of monlist[i].relations) {
				monlist_data += rel.first + "=" + rel.second + "&";
			}
			monlist_data += ">";
		}
		monlist_data = monlist_data.replace(/&>/g, ">");

		let txtbox = document.getElementById("save_txtbox");

		if(txtbox) txtbox.setAttribute("value", monlist_data);
	}

	function btn_import() {
		let importraw = document.getElementById("save_txtbox").value;
		if(importraw) {
			let import_monlist = importraw.split(">");
			let new_monlist = [];
			let new_monnamelist = [];
			for(const montxt of import_monlist) {
				if(!montxt) continue;
				let import_name_and_relation = montxt.split("<");
				if(import_name_and_relation.length != 2) {
					alert("データが破損しています！");
					return;
				}

				let myname = sanitize(import_name_and_relation[0]);
				if(!myname) {
					alert("データが破損しています！");
					return;
				}
				new_monnamelist.push(myname);

				let mymon = new Monoid;
				let import_relations = import_name_and_relation[1].split("&");
				for(const reltxt of import_relations) {
					if(!reltxt) continue;
					let relsplit = reltxt.split("=");
					if(relsplit.length != 2) {
						alert("データが破損しています！");
						return;
					}

					let rel_left = sanitize(relsplit[0]);
					let rel_right = sanitize(relsplit[1]);
					mymon.add_relation(rel_left, rel_right);
				}
				new_monlist.push(mymon);
			}

			if(new_monlist.length) {
				monlist = new_monlist;
				monnamelist = new_monnamelist;
				monoid_list_select(0);

				alert("インポートしました！");
			}
		}
	}

  </script>
	</body>
</html>
