<!DOCTYPE html>
<html>
	<head>
		<title>Word Problem</title>
		<meta charset="utf-8"/>
		<script src="wordprob.js"></script>
	</head>
	<body>
	<h1>Monoid書換え系シミュレータ</h1>
	Monoid:
	<select id="list_monoid" onChange="change_monoid()">
		<option value="0">monoid0</option>
	</select>
	<input type="button" onclick="btn_change_monoidname()" value="名前変更">
	<input type="button" onclick="btn_new_monoid()" value="新規">
	<input type="button" onclick="btn_remove_monoid()" value="削除">
	<input type="button" onclick="btn_import()" value="インポート">
	<input type="button" onclick="btn_export()" value="エクスポート">

	<div id="export_area"></div>
	
	<form id="relation">
		関係式:<input type="text" id="relation_left" value=""> = <input type="text" id="relation_right" value="">
		<input type="button" onclick="btn_add_relation()" value="追加">
	</form>
	<div id="reduced_word">
		<input type="button" onclick="btn_reduce()" value="簡約">
		<input type="text" id="input_word" value=""> = 
	</div>
	<h2>関係式一覧</h2>
	<form id="manipulate_mon">
		<input type="button" onclick="btn_sort()" value="整列">
		<input type="button" onclick="btn_KB()" value="Knuth-Bendix">
		<input type="button" onclick="btn_selall()" value="全選択">
		<input type="button" onclick="btn_erase()" value="消去">
		<input type="button" onclick="btn_confluence()" value="合流的か？">
		<input type="button" onclick="btn_gen_submon()" value="派生Monoid生成">
	</form>
	<div id="relation_view"></div>
	<script language="javascript" type="text/javascript">
	let monlist = [], monnamelist = [];
	monlist.push(new Monoid);
	monnamelist.push("monoid0");
	let mon = monlist[0];
	const reduce_form_html = document.getElementById("reduced_word").innerHTML;
	
	page_update();

	function btn_add_relation() {
		let rel_left = sanitize(document.getElementById("relation_left").value);
		let rel_right = sanitize(document.getElementById("relation_right").value);
		mon.add_relation(rel_left, rel_right);
		page_update();
	}

	function btn_reduce() {
		let w = sanitize(document.getElementById("input_word").value);
		document.getElementById("reduced_word").innerHTML = reduce_form_html + mon.reduce_word(w);
		document.getElementById("input_word").value = w;
	}

	function page_update() {
		show_monoid_list();
		set_mon();
		show_relations();
		document.getElementById("export_area").innerHTML = ""; //close export area
	}

	function show_relations() {
		let innhtml = "<form name=\"rel_checkboxes\">";
		let counter = 1;

		for(const rel of mon.relations) {
			innhtml += "<input type=\"checkbox\" name=\"rels\">";
			innhtml += counter + ". ";
			if(rel.second.length) {
				innhtml += rel.first + " = " + rel.second + "<br>";
			}
			else {
				innhtml += rel.first + " = ε<br>";
			}
			counter++;
		}
		if(!mon.relations.length) innhtml += "なし";
		innhtml += "</form>";

		document.getElementById("relation_view").innerHTML = innhtml;
	};

	function show_monoid_list() {
		let list_monoid = document.getElementById("list_monoid");
		let selected = list_monoid.selectedIndex;

		while(list_monoid.lastChild) list_monoid.removeChild(list_monoid.lastChild);
		for(let i = 0; i < monlist.length; i++) {
			let option = document.createElement("option");
			option.setAttribute("value", i);
			option.innerHTML = monnamelist[i];
			list_monoid.appendChild(option);
		}

		if(selected >= monlist.length) selected = monlist.length - 1;
		list_monoid.options[selected].selected = true;
	}

	function btn_sort() {
		mon.sort_relations();
		page_update();
	}

	function btn_KB() {
		mon.Knuth_Bendix();
		page_update();
	}

	function btn_selall() {
		let myrels = document.rel_checkboxes.rels;
		
		if(myrels) {
			if(myrels.length > 1) {
				for(const box of myrels) {
					box.checked = true;
				}
			}
			else {
				myrels.checked = true;
			}
		}
	}

	function btn_erase() {
		let myrels = document.rel_checkboxes.rels;
		let counter = 0;
		
		if(myrels) {
			if(myrels.length > 1) {
				for(const box of myrels) {
					if(box.checked) mon.relations[counter].first = "";
					counter++;
				}
			}
			else {
				if(myrels.checked) mon.relations[0].first = "";
			}
			mon.relations = mon.relations.filter( function (rel) {
  	    return rel.first;
    	});
			page_update();
		}
	}

	function btn_confluence() {
		is_confl = mon.confluence();
		if(is_confl) alert("合流的ですO(^o^)O");
		else alert("合流的じゃない;O(>o<)O;");
	}

	function set_mon() {
		let listbox = document.getElementById("list_monoid");
		mon = monlist[listbox.options[listbox.selectedIndex].value];
	}

	function change_monoid() {
		page_update();
	}

	function btn_change_monoidname() {
		let listbox = document.getElementById("list_monoid");
		
		let newname = sanitize(window.prompt(monnamelist[listbox.selectedIndex] + "の新しい名前", monnamelist[listbox.selectedIndex]));
		if(newname) {
			monnamelist[listbox.selectedIndex] = newname;
			page_update();
		}
	}

	function monoid_list_select(index) {
		let list_monoid = document.getElementById("list_monoid");
		if(index >= monlist.length) index = monlist.length - 1;
		list_monoid.options[index].selected = true;
		page_update();
	}

	function btn_new_monoid(name_cand = "") {
		if(!name_cand) name_cand = "monoid" + monlist.length;

		let newname = sanitize(window.prompt("新しいMonoidの名前", name_cand));
		if(newname) {
			monnamelist.push(newname);
			monlist.push(new Monoid);
			page_update();
			monoid_list_select(monlist.length - 1);
		}

		return newname;
	}

	function btn_remove_monoid() {
		let listbox = document.getElementById("list_monoid");

		if(monlist.length <= 1) {
			alert("最後の一つは削除できません！");
			return;
		}

		if(confirm("本当に" + monnamelist[listbox.selectedIndex] + "を削除しますか(´・ω・`)？")) {
			monnamelist.splice(listbox.selectedIndex, 1);
			monlist.splice(listbox.selectedIndex, 1);
			page_update();
		}
	}

	function btn_gen_submon() {
		let list_monoid = document.getElementById("list_monoid");
		let name_cand = monnamelist[list_monoid.selectedIndex] + "_sub";
		let newrellist = [];
		let myrels = document.rel_checkboxes.rels;
		
		if(myrels) {
			let counter = 0;
			if(myrels.length > 1) {
				for(const box of myrels) {
					if(box.checked) {
						name_cand += counter + 1;
						newrellist.push(mon.relations[counter]);
					}
					counter++;
				}
			}
			else {
				if(myrels.checked) newrellist.push(mon.relations[0]);
			}

			if(btn_new_monoid(name_cand)) {
				mon.relations = newrellist.slice();
			}
			page_update();
		}
	}

	function sanitize(text) {
		return text.replace(/[\x00-\x20<=>"'&\x7f-\x9f]/g, "");
	}

	// format: monname0<rel0f=rel0s&rel1f=rel1s&...>monname1...
	function btn_export() {
		monlist_data = "";
		for(let i = 0; i < monlist.length; i++) {
			monlist_data += monnamelist[i] + "<";
			for(const rel of monlist[i].relations) {
				monlist_data += rel.first + "=" + rel.second + "&";
			}
			monlist_data += ">";
		}
		monlist_data = monlist_data.replace(/&>/g, ">");

		let txtbox = document.getElementById("export_txtbox");

		if(!txtbox) {
			txtbox = document.createElement("input");
			txtbox.setAttribute("type", "text");
			txtbox.setAttribute("id", "export_txtbox");
			txtbox.readOnly = true;
			txtbox.setAttribute("onfocus", "this.select()");
		
			let export_area = document.getElementById("export_area");
			export_area.innerHTML = "エクスポートデータ:";
			export_area.appendChild(txtbox);
		}
		txtbox.setAttribute("value", monlist_data);
	}

	function btn_import() {
		let importraw = window.prompt("前回のデータをインポート", "");
		if(importraw) {
			let import_monlist = importraw.split(">");
			let new_monlist = [];
			let new_monnamelist = [];
			for(const montxt of import_monlist) {
				if(!montxt) continue;
				let import_name_and_relation = montxt.split("<");
				if(import_name_and_relation.length != 2) {
					alert("データが破損しています！");
					return;
				}

				let myname = sanitize(import_name_and_relation[0]);
				if(!myname) {
					alert("データが破損しています！");
					return;
				}
				new_monnamelist.push(myname);

				let mymon = new Monoid;
				let import_relations = import_name_and_relation[1].split("&");
				for(const reltxt of import_relations) {
					if(!reltxt) continue;
					let relsplit = reltxt.split("=");
					if(relsplit.length != 2) {
						alert("データが破損しています！");
						return;
					}

					let rel_left = sanitize(relsplit[0]);
					let rel_right = sanitize(relsplit[1]);
					mymon.add_relation(rel_left, rel_right);
				}
				new_monlist.push(mymon);
			}
			monlist = new_monlist;
			monnamelist = new_monnamelist;
			monoid_list_select(0);
		}
	}

  </script>
	</body>
</html>
